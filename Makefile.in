
SHELL = @bash@ -o pipefail -o nounset -o errexit

# Copyright 2014-2015 Georgia Tech Research Corporation (GTRC). All rights reserved.

# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.

# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.

# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

prefix = @prefix@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

GREP = @GREP@
INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@
SED = @SED@

find = @find@
m4 = @m4@
tar = @tar@
zip = @zip@

dist_name = $(PACKAGE_NAME)-$(PACKAGE_VERSION)
share_dir_rel = share/${PACKAGE_NAME}
build_dir = tmp/build
all_dir = tmp/all

src_files = $(shell $(find) src -type f ! -name '*~' ! -name '\#*\#' -print)

step_files := ${src_files}
step_files := ${step_files:src/%=${build_dir}/%}
step_files := ${step_files:${build_dir}/share/%=${build_dir}/${share_dir_rel}/%}
step_files := ${step_files:${build_dir}/%=${all_dir}/%}

all_files = ${step_files}

install_files = $(all_files:${all_dir}/%=${prefix}/%)

default: all

.PHONY: help # Print this help
help:
	@ echo Available targets:
	@ $(SED) -e 's/^.PHONY: *\([^ #]*\) *\# *\(.*\)$$/  \1: \2/p;d' Makefile

#############################################################################
# all

.PHONY: all # Build all products
all: $(all_files)

${all_dir}/%: ${build_dir}/%
	${MKDIR_P} ${dir $@}
	${INSTALL} -m 644 $< $@

#############################################################################
# build

${build_dir}/${share_dir_rel}/%: src/share/%
	$(MKDIR_P) $(dir $@)
	cp $< $@

${build_dir}/%: src/%
	$(MKDIR_P) $(dir $@)
	cp $< $@

#############################################################################
# install

.PHONY: install # Install products to ${prefix} (defaults to @prefix@, set via configure)
install: $(install_files)

.PHONY: uninstall # Remove installed products
uninstall:
	$(RM) $(install_files)

$(prefix)/bin/%: ${all_dir}/bin/%
	$(MKDIR_P) $(dir $@)
	$(INSTALL) -m 755 $< $@

${prefix}/%: ${all_dir}/%
	$(MKDIR_P) $(dir $@)
	$(INSTALL) -m 644 $< $@

#############################################################################

.PHONY: clean # Remove products of make
clean:
	$(RM) -r tmp/all
	$(RM) $(wildcard *~)

.PHONY: distclean # Remove products of configure
distclean: clean
	$(RM) -r autom4te.cache tmp
	$(RM) Makefile config.log config.status stow.mk

`.PHONY: zip # Make a zip file
zip: 
	$(MAKE)
	${RM} -r tmp/${dist_name}
	$(MAKE) prefix=tmp/${dist_name} install
	cd tmp && $(zip) -9 -r $(dist_name).zip $(dist_name)

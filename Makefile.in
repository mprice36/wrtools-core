
# Copyright 2014-2015 Georgia Tech Research Corporation (GTRC). All rights reserved.

# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.

# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.

# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

SHELL = @bash@

PACKAGE_NAME = @PACKAGE_NAME@
prefix = @prefix@
datarootdir = @datarootdir@
datadir = @datadir@
exec_prefix = @exec_prefix@
bindir = @bindir@

bash_dir = $(datadir)/bash

GREP = @GREP@
INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@
SED = @SED@

basename = @basename@
bash = @bash@
dirname = @dirname@
find = @find@
m4 = @m4@
mktemp = @mktemp@
rm = @rm@

RM = $(rm) -f

standard_macros = \
	-DCONFIG_BASH_COMMAND=$(bash) \
	-DCONFIG_BASH_DIR=$(bash_dir) \
	-DCONFIG_SED_COMMAND=$(SED) \
	-DCONFIG_M4_COMMAND=$(m4) \
	-DCONFIG_MKTEMP_COMMAND=$(mktemp) \
	-DCONFIG_BASENAME_COMMAND=$(basename) \
	-DCONFIG_DIRNAME_COMMAND=$(dirname) \

src_bin_files = $(shell $(find) src/bin -type f ! -name '*~' ! -name '\#*\#' -print)
src_bash_files = $(shell $(find) src/bash -type f ! -name '*~' ! -name '\#*\#' -print)

out_files = $(src_bin_files:src/bin/%=out/bin/%) $(src_bash_files:src/bash/%=out/bash/%)

install_files = $(src_bin_files:src/bin/%=$(bindir)/%) $(src_bash_files:src/bash/%=$(bash_dir)/%)

.PHONY: all clean distclean install uninstall

all: $(out_files)

out/bin/%: src/bin/% src/macros.m4
	$(MKDIR_P) $(dir $@)
	$(m4) -P $(standard_macros) \
		-DCONFIG_SUBJECT_PATH=$(@:out/bin/%=$(bindir)/%) \
		-DCONFIG_SUBJECT_NAME=$(notdir $@) \
		src/macros.m4 $< > $@
	@ ! $(GREP) 'CONFIG''_' $@

out/bash/%: src/bash/% src/macros.m4
	$(MKDIR_P) $(dir $@)
	$(m4) -P $(standard_macros) \
		-DCONFIG_SUBJECT_PATH=$(@:out/bash/%=$(bash_dir)/%) \
		-DCONFIG_SUBJECT_NAME=$(notdir $@) \
		src/macros.m4 $< > $@
	@ ! $(GREP) 'CONFIG''_' $@

clean:
	$(RM) -r out
	$(RM) $(wildcard *~)

distclean: clean
	$(RM) -r autom4te.cache
	$(RM) Makefile config.log config.status stow.mk

install: $(install_files)

$(bindir)/%: out/bin/%
	$(INSTALL) -D -m 755 $< $@

$(bash_dir)/%: out/bash/%
	$(INSTALL) -D -m 644 $< $@

uninstall:
	$(RM) $(install_files)

